<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sản Phẩm</title>
</head>
<body>
<h1>QUẢN LÝ SẢN PHẨM</h1>
<p>
    <a href="them-san-pham-hoan-chinh.html">+ Thêm sản phẩm hoàn chỉnh</a> | 
    <a href="sanpham-chi-tiet-quan-ly.html">→ Quản lý sản phẩm chi tiết</a> |
    <a href="quan-ly-danh-muc.html">→ Quản lý danh mục</a>
</p>

<!-- Form thêm/sửa sản phẩm -->


<hr>

<!-- Danh sách sản phẩm -->
<h2>DANH SÁCH SẢN PHẨM</h2>
<table border="1" cellpadding="5" cellspacing="0" width="100%">
    <thead>
    <tr>
        <th>ID</th>
        <th>Mã SP</th>
        <th>Tên sản phẩm</th>
        <th>Mô tả</th>
        <th>Hình ảnh</th>
        <th>Thương hiệu</th>
        <th>Danh mục</th>
        <th>Phong cách</th>
        <th>Trạng thái</th>
        <th>Thao tác</th>
    </tr>
    </thead>
    <tbody id="productTableBody">
    <tr>
        <td colspan="10">Đang tải dữ liệu...</td>
    </tr>
    </tbody>
</table>

<h2 id="formTitle">THÊM MỚI SẢN PHẨM</h2>
<form id="sanPhamForm">
    <input type="hidden" id="productId">

    <table border="1" cellpadding="5">
        <tr>
            <td><label>Mã sản phẩm:</label></td>
            <td><input type="text" id="maSanPham" required></td>
        </tr>
        <tr>
            <td><label>Tên sản phẩm:</label></td>
            <td><input type="text" id="tenSanPham" required></td>
        </tr>
        <tr>
            <td><label>Mô tả:</label></td>
            <td><textarea id="moTa" rows="3" cols="30"></textarea></td>
        </tr>
        <tr>
            <td><label>Hình ảnh:</label></td>
            <td>
                <input type="file" id="hinhAnhFile" accept="image/*">
                <img id="previewImage" src="" alt="Preview" style="max-width: 200px; max-height: 200px; margin-top: 10px; display: none;">
                <input type="hidden" id="hinhAnh">
            </td>
        </tr>
        <tr>
            <td><label>Thương hiệu:</label></td>
            <td>
                <select id="idThuongHieu" required>
                    <option value="">-- Chọn thương hiệu --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Danh mục:</label></td>
            <td>
                <select id="idDanhMuc" required>
                    <option value="">-- Chọn danh mục --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Phong cách:</label></td>
            <td><input type="text" id="phongCach"></td>
        </tr>
        <tr>
            <td><label>Trạng thái:</label></td>
            <td>
                <input type="radio" name="trangThai" value="true" checked> Hoạt động
                <input type="radio" name="trangThai" value="false"> Không hoạt động
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button type="submit" id="btnSubmit">Thêm mới</button>
                <button type="button" onclick="resetForm()">Hủy</button>
            </td>
        </tr>
    </table>
</form>
<script>
    const API_URL = 'http://localhost:8080/api';
    let isEditing = false;

    // Lắng nghe sự kiện thay đổi file input
    document.getElementById('hinhAnhFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('previewImage');
                preview.src = event.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Tải danh sách sản phẩm
    async function loadProducts() {
        try {
            const response = await fetch(`${API_URL}/san-pham`);
            const products = await response.json();

            const tbody = document.getElementById('productTableBody');

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10">Không có dữ liệu</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => {
                const imgHtml = product.hinhAnh ? 
                    `<img src="${product.hinhAnh}" alt="Ảnh" style="max-width: 100px; max-height: 100px;">` : 
                    '<span>Không có ảnh</span>';
                
                return `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.maSanPham}</td>
                        <td>${product.tenSanPham}</td>
                        <td>${product.moTa || ''}</td>
                        <td>${imgHtml}</td>
                        <td>${product.tenThuongHieu || ''}</td>
                        <td>${product.tenDanhMuc || ''}</td>
                        <td>${product.phongCach || ''}</td>
                        <td>${product.trangThai ? 'Hoạt động' : 'Không hoạt động'}</td>
                        <td>
                            <button onclick="editProduct(${product.id})">Sửa</button>
                            <button onclick="deleteProduct(${product.id})">Xóa</button>
                            <button onclick="viewDetail(${product.id})">Xem chi tiết</button>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (error) {
            console.error('Lỗi khi tải danh sách:', error);
            alert('Không thể tải danh sách sản phẩm');
        }
    }

    // Tải danh sách thương hiệu
    async function loadThuongHieu() {
        try {
            const response = await fetch(`${API_URL}/thuong-hieu`);
            const list = await response.json();

            const select = document.getElementById('idThuongHieu');
            select.innerHTML = '<option value="">-- Chọn thương hiệu --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenThuongHieu}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải thương hiệu:', error);
        }
    }

    // Tải danh sách danh mục
    async function loadDanhMuc() {
        try {
            const response = await fetch(`${API_URL}/danh-muc`);
            const list = await response.json();

            const select = document.getElementById('idDanhMuc');
            select.innerHTML = '<option value="">-- Chọn danh mục --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenDanhMuc}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải danh mục:', error);
        }
    }

    // Submit form (Thêm/Sửa)
    document.getElementById('sanPhamForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('productId').value;
        const fileInput = document.getElementById('hinhAnhFile');
        
        // Nếu có file ảnh được chọn, upload riêng trước
        let hinhAnh = document.getElementById('hinhAnh').value;
        
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                let uploadEndpoint = `${API_URL}/san-pham/upload`;
                let uploadMethod = 'POST';
                
                // Nếu đang sửa, upload ảnh sẽ tự động xóa ảnh cũ
                if (isEditing && id) {
                    uploadEndpoint = `${API_URL}/san-pham/${id}/upload`;
                    uploadMethod = 'PUT';
                }

                const uploadResponse = await fetch(uploadEndpoint, {
                    method: uploadMethod,
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const error = await uploadResponse.text();
                    alert('Lỗi upload ảnh: ' + error);
                    return;
                }

                const uploadData = await uploadResponse.json();
                // Lấy filePath từ response
                hinhAnh = uploadData.filePath || uploadData.hinhAnh;
            } catch (error) {
                console.error('Lỗi upload ảnh:', error);
                alert('Lỗi upload ảnh: ' + error.message);
                return;
            }
        }

        const data = {
            maSanPham: document.getElementById('maSanPham').value,
            tenSanPham: document.getElementById('tenSanPham').value,
            moTa: document.getElementById('moTa').value,
            hinhAnh: hinhAnh,
            idThuongHieu: parseInt(document.getElementById('idThuongHieu').value),
            idDanhMuc: parseInt(document.getElementById('idDanhMuc').value),
            phongCach: document.getElementById('phongCach').value,
            trangThai: document.querySelector('input[name="trangThai"]:checked').value === 'true'
        };

        try {
            let response;
            if (isEditing && id) {
                // Cập nhật
                response = await fetch(`${API_URL}/san-pham/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Thêm mới
                response = await fetch(`${API_URL}/san-pham`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                alert(isEditing ? 'Cập nhật thành công!' : 'Thêm mới thành công!');
                resetForm();
                loadProducts();
            } else {
                const error = await response.text();
                alert('Lỗi: ' + error);
            }
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra!');
        }
    });

    // Xem chi tiết sản phẩm
    function viewDetail(id) {
        window.location.href = `sanpham-chi-tiet.html?id=${id}`;
    }

    // Sửa sản phẩm
    async function editProduct(id) {
        try {
            const response = await fetch(`${API_URL}/san-pham/${id}`);
            const product = await response.json();

            document.getElementById('productId').value = product.id;
            document.getElementById('maSanPham').value = product.maSanPham;
            document.getElementById('tenSanPham').value = product.tenSanPham;
            document.getElementById('moTa').value = product.moTa || '';
            document.getElementById('hinhAnh').value = product.hinhAnh || '';
            document.getElementById('idThuongHieu').value = product.idThuongHieu;
            document.getElementById('idDanhMuc').value = product.idDanhMuc;
            document.getElementById('phongCach').value = product.phongCach || '';

            // Hiển thị ảnh hiện tại
            if (product.hinhAnh) {
                const preview = document.getElementById('previewImage');
                preview.src = product.hinhAnh;
                preview.style.display = 'block';
            }

            const radioButtons = document.querySelectorAll('input[name="trangThai"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === product.trangThai.toString();
            });

            document.getElementById('formTitle').innerText = 'CẬP NHẬT SẢN PHẨM';
            document.getElementById('btnSubmit').innerText = 'Cập nhật';
            isEditing = true;

            window.scrollTo(0, 0);
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Không thể tải thông tin sản phẩm');
        }
    }

    // Xóa sản phẩm
    async function deleteProduct(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/san-pham/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Xóa thành công!');
                loadProducts();
            } else {
                const error = await response.text();
                alert('Lỗi: ' + error);
            }
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra khi xóa!');
        }
    }

    // Reset form
    function resetForm() {
        document.getElementById('sanPhamForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('hinhAnh').value = '';
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('formTitle').innerText = 'THÊM MỚI SẢN PHẨM';
        document.getElementById('btnSubmit').innerText = 'Thêm mới';
        isEditing = false;
    }

    // Khởi tạo khi trang load
    window.onload = function() {
        loadProducts();
        loadThuongHieu();
        loadDanhMuc();
    };
</script>
</body>
</html>