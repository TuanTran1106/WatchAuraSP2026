<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sản Phẩm Chi Tiết</title>
</head>
<body>
<h1>QUẢN LÝ SẢN PHẨM CHI TIẾT</h1>

<!-- Form thêm/sửa sản phẩm chi tiết -->
<h2 id="formTitle">THÊM MỚI SẢN PHẨM CHI TIẾT</h2>
<form id="sanPhamChiTietForm">
    <input type="hidden" id="chiTietId">

    <table border="1" cellpadding="5">
        <tr>
            <td><label>Sản phẩm:</label></td>
            <td>
                <select id="idSanPham" required>
                    <option value="">-- Chọn sản phẩm --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Màu sắc:</label></td>
            <td>
                <select id="idMauSac">
                    <option value="">-- Chọn màu sắc --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Kích thước:</label></td>
            <td>
                <select id="idKichThuoc">
                    <option value="">-- Chọn kích thước --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Chất liệu dây:</label></td>
            <td>
                <select id="idChatLieuDay">
                    <option value="">-- Chọn chất liệu dây --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Loại máy:</label></td>
            <td>
                <select id="idLoaiMay">
                    <option value="">-- Chọn loại máy --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Giá bán:</label></td>
            <td><input type="number" id="giaBan" step="0.01" required></td>
        </tr>
        <tr>
            <td><label>Số lượng tồn:</label></td>
            <td><input type="number" id="soLuongTon" required></td>
        </tr>
        <tr>
            <td><label>Đường kính (mm):</label></td>
            <td><input type="number" id="duongKinh" step="0.01"></td>
        </tr>
        <tr>
            <td><label>Độ chịu nước (m):</label></td>
            <td><input type="number" id="doChiuNuoc"></td>
        </tr>
        <tr>
            <td><label>Bề rộng dây (mm):</label></td>
            <td><input type="number" id="beRongDay" step="0.01"></td>
        </tr>
        <tr>
            <td><label>Trọng lượng (g):</label></td>
            <td><input type="number" id="trongLuong" step="0.01"></td>
        </tr>
        <tr>
            <td><label>Trạng thái:</label></td>
            <td>
                <input type="radio" name="trangThai" value="true" checked> Hoạt động
                <input type="radio" name="trangThai" value="false"> Không hoạt động
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button type="submit" id="btnSubmit">Thêm mới</button>
                <button type="button" onclick="resetForm()">Hủy</button>
            </td>
        </tr>
    </table>
</form>

<hr>

<!-- Danh sách sản phẩm chi tiết -->
<h2>DANH SÁCH SẢN PHẨM CHI TIẾT</h2>
<table border="1" cellpadding="5" cellspacing="0" width="100%">
    <thead>
    <tr>
        <th>ID</th>
        <th>Sản phẩm</th>
        <th>Màu sắc</th>
        <th>Kích thước</th>
        <th>Chất liệu dây</th>
        <th>Loại máy</th>
        <th>Giá bán</th>
        <th>Số lượng tồn</th>
        <th>Đường kính</th>
        <th>Độ chịu nước</th>
        <th>Bề rộng dây</th>
        <th>Trọng lượng</th>
        <th>Trạng thái</th>
        <th>Thao tác</th>
    </tr>
    </thead>
    <tbody id="detailsTableBody">
    <tr>
        <td colspan="14">Đang tải dữ liệu...</td>
    </tr>
    </tbody>
</table>

<script>
    const API_URL = 'http://localhost:8080/api';
    let isEditing = false;

    // Tải danh sách sản phẩm chi tiết
    async function loadChiTiet() {
        try {
            const response = await fetch(`${API_URL}/san-pham-chi-tiet`);
            const chiTiets = await response.json();

            const tbody = document.getElementById('detailsTableBody');

            if (chiTiets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14">Không có dữ liệu</td></tr>';
                return;
            }

            tbody.innerHTML = chiTiets.map(ct => `
                    <tr>
                        <td>${ct.id}</td>
                        <td>${ct.tenSanPham || ''}</td>
                        <td>${ct.tenMauSac || ''}</td>
                        <td>${ct.tenKichThuoc || ''}</td>
                        <td>${ct.tenChatLieuDay || ''}</td>
                        <td>${ct.tenLoaiMay || ''}</td>
                        <td>${ct.giaBan || ''}</td>
                        <td>${ct.soLuongTon || ''}</td>
                        <td>${ct.duongKinh || ''}</td>
                        <td>${ct.doChiuNuoc || ''}</td>
                        <td>${ct.beRongDay || ''}</td>
                        <td>${ct.trongLuong || ''}</td>
                        <td>${ct.trangThai ? 'Hoạt động' : 'Không hoạt động'}</td>
                        <td>
                            <button onclick="editChiTiet(${ct.id})">Sửa</button>
                            <button onclick="deleteChiTiet(${ct.id})">Xóa</button>
                        </td>
                    </tr>
                `).join('');
        } catch (error) {
            console.error('Lỗi khi tải danh sách:', error);
            alert('Không thể tải danh sách sản phẩm chi tiết');
        }
    }

    // Tải danh sách sản phẩm
    async function loadSanPham() {
        try {
            const response = await fetch(`${API_URL}/san-pham`);
            const list = await response.json();

            const select = document.getElementById('idSanPham');
            select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenSanPham}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải sản phẩm:', error);
        }
    }

    // Tải danh sách màu sắc
    async function loadMauSac() {
        try {
            const response = await fetch(`${API_URL}/mau-sac`);
            const list = await response.json();

            const select = document.getElementById('idMauSac');
            select.innerHTML = '<option value="">-- Chọn màu sắc --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenMauSac}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải màu sắc:', error);
        }
    }

    // Tải danh sách kích thước
    async function loadKichThuoc() {
        try {
            const response = await fetch(`${API_URL}/kich-thuoc`);
            const list = await response.json();

            const select = document.getElementById('idKichThuoc');
            select.innerHTML = '<option value="">-- Chọn kích thước --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenKichThuoc}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải kích thước:', error);
        }
    }

    // Tải danh sách chất liệu dây
    async function loadChatLieuDay() {
        try {
            const response = await fetch(`${API_URL}/chat-lieu-day`);
            const list = await response.json();

            const select = document.getElementById('idChatLieuDay');
            select.innerHTML = '<option value="">-- Chọn chất liệu dây --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenChatLieu}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải chất liệu dây:', error);
        }
    }

    // Tải danh sách loại máy
    async function loadLoaiMay() {
        try {
            const response = await fetch(`${API_URL}/loai-may`);
            const list = await response.json();

            const select = document.getElementById('idLoaiMay');
            select.innerHTML = '<option value="">-- Chọn loại máy --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenLoaiMay}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải loại máy:', error);
        }
    }

    // Submit form (Thêm/Sửa)
    document.getElementById('sanPhamChiTietForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = document.getElementById('chiTietId').value;
        const data = {
            idSanPham: parseInt(document.getElementById('idSanPham').value),
            idMauSac: document.getElementById('idMauSac').value ? parseInt(document.getElementById('idMauSac').value) : null,
            idKichThuoc: document.getElementById('idKichThuoc').value ? parseInt(document.getElementById('idKichThuoc').value) : null,
            idChatLieuDay: document.getElementById('idChatLieuDay').value ? parseInt(document.getElementById('idChatLieuDay').value) : null,
            idLoaiMay: document.getElementById('idLoaiMay').value ? parseInt(document.getElementById('idLoaiMay').value) : null,
            giaBan: parseFloat(document.getElementById('giaBan').value),
            soLuongTon: parseInt(document.getElementById('soLuongTon').value),
            duongKinh: document.getElementById('duongKinh').value ? parseFloat(document.getElementById('duongKinh').value) : null,
            doChiuNuoc: document.getElementById('doChiuNuoc').value ? parseInt(document.getElementById('doChiuNuoc').value) : null,
            beRongDay: document.getElementById('beRongDay').value ? parseFloat(document.getElementById('beRongDay').value) : null,
            trongLuong: document.getElementById('trongLuong').value ? parseFloat(document.getElementById('trongLuong').value) : null,
            trangThai: document.querySelector('input[name="trangThai"]:checked').value === 'true'
        };

        try {
            let response;
            if (isEditing && id) {
                // Cập nhật
                response = await fetch(`${API_URL}/san-pham-chi-tiet/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Thêm mới
                response = await fetch(`${API_URL}/san-pham-chi-tiet`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                alert(isEditing ? 'Cập nhật thành công!' : 'Thêm mới thành công!');
                resetForm();
                loadChiTiet();
            } else {
                const error = await response.text();
                alert('Lỗi: ' + error);
            }
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra!');
        }
    });

    // Sửa sản phẩm chi tiết
    async function editChiTiet(id) {
        try {
            const response = await fetch(`${API_URL}/san-pham-chi-tiet/${id}`);
            const chiTiet = await response.json();

            document.getElementById('chiTietId').value = chiTiet.id;
            document.getElementById('idSanPham').value = chiTiet.idSanPham;
            document.getElementById('idMauSac').value = chiTiet.idMauSac || '';
            document.getElementById('idKichThuoc').value = chiTiet.idKichThuoc || '';
            document.getElementById('idChatLieuDay').value = chiTiet.idChatLieuDay || '';
            document.getElementById('idLoaiMay').value = chiTiet.idLoaiMay || '';
            document.getElementById('giaBan').value = chiTiet.giaBan || '';
            document.getElementById('soLuongTon').value = chiTiet.soLuongTon || '';
            document.getElementById('duongKinh').value = chiTiet.duongKinh || '';
            document.getElementById('doChiuNuoc').value = chiTiet.doChiuNuoc || '';
            document.getElementById('beRongDay').value = chiTiet.beRongDay || '';
            document.getElementById('trongLuong').value = chiTiet.trongLuong || '';

            const radioButtons = document.querySelectorAll('input[name="trangThai"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === chiTiet.trangThai.toString();
            });

            document.getElementById('formTitle').innerText = 'CẬP NHẬT SẢN PHẨM CHI TIẾT';
            document.getElementById('btnSubmit').innerText = 'Cập nhật';
            isEditing = true;

            window.scrollTo(0, 0);
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Không thể tải thông tin sản phẩm chi tiết');
        }
    }

    // Xóa sản phẩm chi tiết
    async function deleteChiTiet(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm chi tiết này?')) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/san-pham-chi-tiet/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Xóa thành công!');
                loadChiTiet();
            } else {
                const error = await response.text();
                alert('Lỗi: ' + error);
            }
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra khi xóa!');
        }
    }

    // Reset form
    function resetForm() {
        document.getElementById('sanPhamChiTietForm').reset();
        document.getElementById('chiTietId').value = '';
        document.getElementById('formTitle').innerText = 'THÊM MỚI SẢN PHẨM CHI TIẾT';
        document.getElementById('btnSubmit').innerText = 'Thêm mới';
        isEditing = false;
    }

    // Khởi tạo khi trang load
    window.onload = function() {
        loadChiTiet();
        loadSanPham();
        loadMauSac();
        loadKichThuoc();
        loadChatLieuDay();
        loadLoaiMay();
    };
</script>
</body>
</html>
