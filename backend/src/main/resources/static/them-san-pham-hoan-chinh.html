<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Sản Phẩm Hoàn Chỉnh</title>
</head>
<body>
<h1>THÊM SẢN PHẨM</h1>
<p><a href="sanpham.html">← Quay lại danh sách sản phẩm</a></p>

<h2>THÔNG TIN SẢN PHẨM</h2>
<form id="sanPhamHoanChinhForm">
    <table border="1" cellpadding="5">
        <tr>
            <td><label>Mã sản phẩm:</label></td>
            <td><input type="text" id="maSanPham" required></td>
        </tr>
        <tr>
            <td><label>Tên sản phẩm:</label></td>
            <td><input type="text" id="tenSanPham" required></td>
        </tr>
        <tr>
            <td><label>Mô tả:</label></td>
            <td><textarea id="moTa" rows="3" cols="30"></textarea></td>
        </tr>
        <tr>
            <td><label>Hình ảnh:</label></td>
            <td>
                <input type="file" id="hinhAnhFile" accept="image/*">
                <img id="previewImage" src="" alt="Preview" style="max-width: 200px; max-height: 200px; margin-top: 10px; display: none;">
            </td>
        </tr>
        <tr>
            <td><label>Thương hiệu:</label></td>
            <td>
                <select id="idThuongHieu" required>
                    <option value="">-- Chọn thương hiệu --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Danh mục:</label></td>
            <td>
                <select id="idDanhMuc" required>
                    <option value="">-- Chọn danh mục --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Phong cách:</label></td>
            <td><input type="text" id="phongCach"></td>
        </tr>
        <tr>
            <td><label>Trạng thái sản phẩm:</label></td>
            <td>
                <input type="radio" name="trangThaiSP" value="true" checked> Hoạt động
                <input type="radio" name="trangThaiSP" value="false"> Không hoạt động
            </td>
        </tr>
<!--    </table>-->

<!--    <h2>CHI TIẾT SẢN PHẨM</h2>-->
<!--    <table border="1" cellpadding="5">-->
        <tr>
            <td><label>Màu sắc:</label></td>
            <td>
                <select id="idMauSac">
                    <option value="">-- Chọn màu sắc --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Kích thước:</label></td>
            <td>
                <select id="idKichThuoc">
                    <option value="">-- Chọn kích thước --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Chất liệu dây:</label></td>
            <td>
                <select id="idChatLieuDay">
                    <option value="">-- Chọn chất liệu dây --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Loại máy:</label></td>
            <td>
                <select id="idLoaiMay">
                    <option value="">-- Chọn loại máy --</option>
                </select>
            </td>
        </tr>
        <tr>
            <td><label>Giá bán:</label></td>
            <td><input type="number" id="giaBan" step="0.01" required></td>
        </tr>
        <tr>
            <td><label>Số lượng tồn:</label></td>
            <td><input type="number" id="soLuongTon" required></td>
        </tr>
        <tr>
            <td><label>Đường kính (mm):</label></td>
            <td><input type="number" id="duongKinh" step="0.01"></td>
        </tr>
        <tr>
            <td><label>Độ chịu nước (m):</label></td>
            <td><input type="number" id="doChiuNuoc"></td>
        </tr>
        <tr>
            <td><label>Bề rộng dây (mm):</label></td>
            <td><input type="number" id="beRongDay" step="0.01"></td>
        </tr>
        <tr>
            <td><label>Trọng lượng (g):</label></td>
            <td><input type="number" id="trongLuong" step="0.01"></td>
        </tr>
        <tr>
            <td><label>Trạng thái chi tiết:</label></td>
            <td>
                <input type="radio" name="trangThaiCT" value="true" checked> Hoạt động
                <input type="radio" name="trangThaiCT" value="false"> Không hoạt động
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <button type="submit">Thêm sản phẩm hoàn chỉnh</button>
                <button type="button" onclick="goBack()">Hủy</button>
            </td>
        </tr>
    </table>
</form>

<script>
    const API_URL = 'http://localhost:8080/api';
    let uploadedImagePath = '';

    // Lắng nghe sự kiện thay đổi file input
    document.getElementById('hinhAnhFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('previewImage');
                preview.src = event.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Tải danh sách thương hiệu
    async function loadThuongHieu() {
        try {
            const response = await fetch(`${API_URL}/thuong-hieu`);
            const list = await response.json();

            const select = document.getElementById('idThuongHieu');
            select.innerHTML = '<option value="">-- Chọn thương hiệu --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenThuongHieu}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải thương hiệu:', error);
        }
    }

    // Tải danh sách danh mục
    async function loadDanhMuc() {
        try {
            const response = await fetch(`${API_URL}/danh-muc`);
            const list = await response.json();

            const select = document.getElementById('idDanhMuc');
            select.innerHTML = '<option value="">-- Chọn danh mục --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenDanhMuc}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải danh mục:', error);
        }
    }

    // Tải danh sách màu sắc
    async function loadMauSac() {
        try {
            const response = await fetch(`${API_URL}/mau-sac`);
            const list = await response.json();

            const select = document.getElementById('idMauSac');
            select.innerHTML = '<option value="">-- Chọn màu sắc --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenMauSac}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải màu sắc:', error);
        }
    }

    // Tải danh sách kích thước
    async function loadKichThuoc() {
        try {
            const response = await fetch(`${API_URL}/kich-thuoc`);
            const list = await response.json();

            const select = document.getElementById('idKichThuoc');
            select.innerHTML = '<option value="">-- Chọn kích thước --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenKichThuoc}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải kích thước:', error);
        }
    }

    // Tải danh sách chất liệu dây
    async function loadChatLieuDay() {
        try {
            const response = await fetch(`${API_URL}/chat-lieu-day`);
            const list = await response.json();

            const select = document.getElementById('idChatLieuDay');
            select.innerHTML = '<option value="">-- Chọn chất liệu dây --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenChatLieu}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải chất liệu dây:', error);
        }
    }

    // Tải danh sách loại máy
    async function loadLoaiMay() {
        try {
            const response = await fetch(`${API_URL}/loai-may`);
            const list = await response.json();

            const select = document.getElementById('idLoaiMay');
            select.innerHTML = '<option value="">-- Chọn loại máy --</option>' +
                list.map(item => `<option value="${item.id}">${item.tenLoaiMay}</option>`).join('');
        } catch (error) {
            console.error('Lỗi khi tải loại máy:', error);
        }
    }

    // Submit form
    document.getElementById('sanPhamHoanChinhForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Upload ảnh trước nếu có
        const fileInput = document.getElementById('hinhAnhFile');
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const uploadResponse = await fetch(`${API_URL}/san-pham/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    alert('Lỗi upload ảnh');
                    return;
                }

                const uploadData = await uploadResponse.json();
                uploadedImagePath = uploadData.filePath;
            } catch (error) {
                console.error('Lỗi upload ảnh:', error);
                alert('Lỗi upload ảnh');
                return;
            }
        }

        // Thêm sản phẩm
        const sanPhamData = {
            maSanPham: document.getElementById('maSanPham').value,
            tenSanPham: document.getElementById('tenSanPham').value,
            moTa: document.getElementById('moTa').value,
            hinhAnh: uploadedImagePath,
            idThuongHieu: parseInt(document.getElementById('idThuongHieu').value),
            idDanhMuc: parseInt(document.getElementById('idDanhMuc').value),
            phongCach: document.getElementById('phongCach').value,
            trangThai: document.querySelector('input[name="trangThaiSP"]:checked').value === 'true'
        };

        try {
            const sanPhamResponse = await fetch(`${API_URL}/san-pham`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sanPhamData)
            });

            if (!sanPhamResponse.ok) {
                const error = await sanPhamResponse.text();
                alert('Lỗi thêm sản phẩm: ' + error);
                return;
            }

            const sanPham = await sanPhamResponse.json();
            const sanPhamId = sanPham.id;

            // Thêm chi tiết sản phẩm
            const chiTietData = {
                idSanPham: sanPhamId,
                idMauSac: document.getElementById('idMauSac').value ? parseInt(document.getElementById('idMauSac').value) : null,
                idKichThuoc: document.getElementById('idKichThuoc').value ? parseInt(document.getElementById('idKichThuoc').value) : null,
                idChatLieuDay: document.getElementById('idChatLieuDay').value ? parseInt(document.getElementById('idChatLieuDay').value) : null,
                idLoaiMay: document.getElementById('idLoaiMay').value ? parseInt(document.getElementById('idLoaiMay').value) : null,
                giaBan: parseFloat(document.getElementById('giaBan').value),
                soLuongTon: parseInt(document.getElementById('soLuongTon').value),
                duongKinh: document.getElementById('duongKinh').value ? parseFloat(document.getElementById('duongKinh').value) : null,
                doChiuNuoc: document.getElementById('doChiuNuoc').value ? parseInt(document.getElementById('doChiuNuoc').value) : null,
                beRongDay: document.getElementById('beRongDay').value ? parseFloat(document.getElementById('beRongDay').value) : null,
                trongLuong: document.getElementById('trongLuong').value ? parseFloat(document.getElementById('trongLuong').value) : null,
                trangThai: document.querySelector('input[name="trangThaiCT"]:checked').value === 'true'
            };

            const chiTietResponse = await fetch(`${API_URL}/san-pham-chi-tiet`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(chiTietData)
            });

            if (!chiTietResponse.ok) {
                const error = await chiTietResponse.text();
                alert('Lỗi thêm chi tiết sản phẩm: ' + error);
                return;
            }

            alert('Thêm sản phẩm hoàn chỉnh thành công!');
            goBack();
        } catch (error) {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra!');
        }
    });

    // Quay lại
    function goBack() {
        window.location.href = 'sanpham.html';
    }

    // Khởi tạo khi trang load
    window.onload = function() {
        loadThuongHieu();
        loadDanhMuc();
        loadMauSac();
        loadKichThuoc();
        loadChatLieuDay();
        loadLoaiMay();
    };
</script>
</body>
</html>
